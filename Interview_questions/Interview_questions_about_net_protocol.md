# 面试题系列之网络协议

## 1. 网络协议基础

### 1.1 七层模型
1. 物理层： 双绞线、无线 2.4G、5G、光线
2. 数据链路层：以太网
3. 网络层：ARP、IPv4、IPv6、ICMP、IPsec
4. 传输层：TCP、UDP、UDP-Lite、SCTP、DCCP
5. 会话层：
6. 表示层：
7. 应用层：HTTP、SSH、FTP、DNS、TELNET、SSL/TLS、SIP

### 1.2 ping 是什么协议
ICMP（Internet Control and Message Protocal）

### 1.3 传输层和网络层分别是做什么的？
- 网络层，用来解决从哪来，到哪去的问题，即在浩瀚网海之中如何准确传递消息
- 传输层，用来传输数据，在网络层的基础之上进行交流，解决消息如何传递的问题。
- 应用层，解决消息如何封装和读取的问题

## 2. IP 协议

## 3. 传输层协议
TCP/UDP 的区别，头部对比：

| TCP | UDP |
|:----|:----|
|面向链接的|无连接|
|可靠的协议|不可靠的|
|效率相对较低|高速、实时性好|
|顺序控制|无|
|重发控制|无|
|流量控制|无|
|拥塞控制|无|
|20个字节，加上可选就是24个字节|固定 8个字节|
### 3.1 TCP 协议

#### 3.1.1 TCP的三次握手四次挥手

MSS Maximum Segments Size 最大消息段长度就是在三次握手的过程中确立的。
建立连接的三次握手过程：

![TCP建立连接](https://ask.qcloudimg.com/http-save/yehe-1446775/uwl5mh9ogf.png?imageView2/2/w/1620)

1. 客户端发送的 TCP 报文中标识位 SYN 置1，初始序号 seq=x（随机）。Client 进入SYN_SENT状态，等待 Server 确认；
2. 服务器收到数据包后，根据标识位 SYN=1 知道 Client 请求建立连接，Server将标识位 SYN 和 ACK 都置为1， ack=x+1，随机产生一个初始序列号 seq=y，并将该数据不傲发送给 Client 以确认建立连接请求，Server 进入 SYN_RCVD 状态；
3. Client收到确认后，检查ack是否为x+1，ACK是否为1，如果正确则将标志位ACK置为1，ack=y+1，并将该数据包发送给Server。Server检查ack是否为y+1，ACK是否为1，如果正确则连接建立成功，Client和Server进入ESTABLISHED状态，完成三次握手，随后Client与Server之间可以开始传输数据了

断开连接的四次回收过程：

![TCP断开连接](https://ask.qcloudimg.com/http-save/yehe-1446775/ok7sodrcza.png?imageView2/2/w/1620)

1. Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态
2. Server收到FIN后，发送一个ACK给Client，确认序号为u + 1（与SYN相同，一个FIN占用一个序号），Server进入CLOSE_WAIT状态
3. Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态
4. Client收到FIN后，Client进入TIME_WAIT状态(主动关闭方才会进入该状态），接着发送一个ACK给Server，确认序号为w + 1，Server进入CLOSED状态，完成四次挥手


#### 3.1.2 TCP滑动窗口，窗口大小，如何确定的？
TCP 协议为了达到更高效的数据发送效率, 会使用一个叫滑动窗口的机制来批量发送数据, 其形式如图：
![TCP滑动窗口](http://user-image.logdown.io/user/12785/blog/12037/post/730737/TsL7H0lRS9W8qRXq1xdS_滑动窗口1)

窗口大小是如何确定的呢？
tcp 有个机制叫慢启动. 一般来讲, 如果 MSS 为 1460 Bytes (以太网标准), 则窗口初始大小设置为 3 MSS 大小. 此后, 根据每次数据往返的 ack, 会逐渐增大这个值. 首次开始数据传输时, 拥塞窗口大小会以 1, 2, 4 这样的指数倍增长, 直到发生超时重发, 窗口会重新开始计算, 并设置一个慢启动阈值, 这个阈值为窗口大小的一半, 当窗口大小超过阈值时, 窗口的增长速率按照一个小于 MSS 大小的比例增长。

如果遇超时重传的情况, 则拥塞窗口大小会重新设置为 (慢启动阈值 + 3 MSS). 而阈值会重新设置为当前窗口的一般. 窗口变化如图：

![TCP拥塞控制](http://user-image.logdown.io/user/12785/blog/12037/post/730737/sqeDKQS8SKUrvlqIxrVn_拥塞窗口)

那么, 最终的窗口大小其实是由接收方的窗口控制参数和拥塞窗口大小共同决定的, 实际发送的窗口数据量大小, 是两者中的较小值.

#### 3.1.4 TCP是如何保证可靠的

TCP 的每个分断都有自己的序号，接受端收到一个分段后会向发送方确认，并附带下一分段的编号，发送收到确认后，就会知道该编号以前到接受方都已经收到了。如果超时未收到确认，那么发送方将重发。

### 3.2 UDP 协议

### 3.2.3 UDP可以实现一对多吗？怎么实现？

## 4. HTTP 协议
超文本传输协议（）

**无状态协议**

**怎么解决无状态**
### 4.1 URI 和 URL

- URI(Uniform Resource Identifier)，统一资源标识符，用来唯一地标识一个资源；
- URL（Uniform Resource Locator），统一资源定位器，它是一种具体的 URI，即 URL 可以用来标识一个资源，而且还指明了如何定位这个资源。

#### 4.1.1 URI
组成部分：

1. 访问资源的命名机制
2. 存放资源的主机名
3. 资源自身的名称，由路径表示，着重强调于资源

#### 4.1.2 URL
组成部分：

1. 协议(或称为服务方式)
2. 存有该资源的主机IP地址(有时也包括端口号)
3. 主机资源的具体地址。如目录和文件名等

### 4.1 HTTP 报文格式

#### 4.1.1 请求报文
![请求报文格式](https://img-blog.csdn.net/20170330192653242?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSG9sbW9meQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

#### 4.1.2 响应报文
![响应报文格式](https://img-blog.csdn.net/20170330192754102?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSG9sbW9meQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

#### 4.1.3 常用头部

**通用首部字段（请求报文与响应报文都会使用的首部字段）**

- Date：创建报文时间
- Connection：连接的管理
- Cache-Control：缓存的控制
- Transfer-Encoding：报文主体的传输编码方式

**请求首部字段（请求报文会使用的首部字段）**

- Host：请求资源所在服务器
- Accept：可处理的媒体类型
- Accept-Charset：可接收的字符集
- Accept-Encoding：可接受的内容编码
- Accept-Language：可接受的自然语言

**响应首部字段（响应报文会使用的首部字段）**

- Accept-Ranges：可接受的字节范围
- Location：令客户端重新定向到的URI
- Server：HTTP服务器的安装信息

**实体首部字段（请求报文与响应报文的的实体部分使用的首部字段）**

- Allow：资源可支持的HTTP方法
- Content-Type：实体主类的类型
- Content-Encoding：实体主体适用的编码方式
- Content-Language：实体主体的自然语言
- Content-Length：实体主体的的字节数
- Content-Range：实体主体的位置范围，一般用于发出部分请求时使用

### 4.2 HTTP请求有哪些方法？如何选择？

- GET 用来向服务器发送请求
- POST 用于将数据发送给服务以创建和更新资源
- HEAD 与 GET 类似，但是没有响应题，仅传输状态行和标题部分
- OPTION 用来描述了目标资源的通信选项
- PUT 向服务器插入内容
- DELETE 向服务器删除内容
- CONNECT 用来建立到给定URI标识的服务器的隧道；它通过简单的TCP / IP隧道更改请求连接，通常实使用解码的HTTP代理来进行SSL编码的通信
- TRACE 用于沿着目标资源的路径执行消息环回测试 

### 4.3 cookie
Cookie是什么？ Cookie 是一小段文本信息，伴随着用户请求和页面在 Web 服务器和浏览器之间传递。Cookie 包含每次用户访问站点时 Web 应用程序都可以读取的信息。

为什么需要Cookie？ 因为HTTP协议是无状态的，对于一个浏览器发出的多次请求，WEB服务器无法区分 是不是来源于同一个浏览器。所以，需要额外的数据用于维护会话。 Cookie 正是这样的一段随HTTP请求一起被传递的额外数据。

Cookie能做什么？ Cookie只是一段文本，所以它只能保存字符串。而且浏览器对它有大小限制以及 它会随着每次请求被发送到服务器，所以应该保证它不要太大。 Cookie的内容也是明文保存的，有些浏览器提供界面修改，所以， 不适合保存重要的或者涉及隐私的内容。

Cookie 的限制。 大多数浏览器支持最大为 4096 字节的 Cookie。由于这限制了 Cookie 的大小，最好用 Cookie 来存储少量数据，或者存储用户 ID 之类的标识符。用户 ID 随后便可用于标识用户，以及从数据库或其他数据源中读取用户信息。 浏览器还限制站点可以在用户计算机上存储的 Cookie 的数量。大多数浏览器只允许每个站点存储 20 个 Cookie；如果试图存储更多 Cookie，则最旧的 Cookie 便会被丢弃。有些浏览器还会对它们将接受的来自所有站点的 Cookie 总数作出绝对限制，通常为 300 个。

通过前面的内容，我们了解到Cookie是用于维持服务端会话状态的，通常由服务端写入，在后续请求中，供服务端读取。 下面本文将按这个过程看看Cookie是如何从服务端写入，最后如何传到服务端以及如何读取的。

## 5 HTTPS 协议

### 5.1 HTTPS 原理
HTTPS 在真正开始 HTTP 请求之前，先与服务器进行几次握手验证，以确定双方身份，如图：

![HTTPS SSL 建立流程](https://images2015.cnblogs.com/blog/366784/201601/366784-20160127222221785-258650029.png)

验证流程：

1. 客户端发起一个 HTTPS 请求，把自身支持的一系列 Sipher Suite （密钥算法套件，简称 Cipher）发送给服务器；
2. 服务段收到后，与自己支持的进行比对，如果不支持断开连接，反之总重选择一个加密算法和HASH算法，以证书的形式返回给客户端，证书中包含了公钥、颁证机构、网址、失效日期等等
3. 客户端收到后，验证证书的合法性，例如，机构是否合法，是否在有效期内，网址是不是一致。验证通过后，或者用户表示可以接受，就会生成一串随机数，然后用证书中的公约加密；然后用之前约定好的hash方式，对握手消息进行hash，让后用 随机数加密“握手消息 + 五首消息hash值（签名）”并一起发送给服务端
4. 服务端对收到的密文进行解密得到随机数，再用随机数密码解密得到握手消息和hash值，然后在与传过来的hash值进行比较，确认是否一致，然后在用同样的方式发给客户端
5. 客户端用随机数解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密

### 5.2 HTTPS 用到的主要加密算法
非对称加密算法：RSA，DSA/DSS     在客户端与服务端相互验证的过程中用的是对称加密 
对称加密算法：AES，RC4，3DES     客户端与服务端相互验证通过后，以随机数作为密钥时，就是对称加密
HASH算法：MD5，SHA1，SHA256  在确认握手消息没有被篡改时 

### 5.3 HTTPS 密钥协商交还的过程，中间人攻击，即charles抓包的原理
熟悉了上面双方互下确认的过程，在中间截获，并用自己的证书进行替换转发即可。

## 6. 项目经验
### 6.1 网络造成卡顿的原因

拥塞，TCP拥塞控制

### 6.2 断点续传怎么实现？需要设置什么？
断点续传其实正如字面意思，就是在下载的断开点继续开始传输，不用再从头开始。所以理解断点续传的核心后，发现其实和很简单，关键就在于对传输中断点的把握，我就自己的理解画了一个简单的示意图：

![文件断点续传方案](https://img-blog.csdn.net/20141206215834127?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhb3dlbjI1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

断点续传的关键是断点，所以在制定传输协议的时候要设计好，如上图，我自定义了一个交互协议，每次下载请求都会带上下载的起始点，这样就可以支持从断点下载了，其实HTTP里的断点续传也是这个原理，在HTTP的头里有个可选的字段RANGE，表示下载的范围。

### 6.3 在杭州 HTTP 请求服务器响应快，可能离服务器距离近，而在深圳访问就很慢很慢，会是什么原因？如果用户投诉，怎么分析这个问题？
其实这是一个比较开放的问题，重点在于考察如何排查网络状况：

1. 首先排查是否是本地网络的问题，例如访问其它服务器是否够快，或者测试一下本地的网络；
2. 测试访问网站是否正常，测试DNS解析是否正确，速率如何，丢包是否严重。
3. 检查 CDN 的状态，



