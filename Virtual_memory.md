# 【笔记】虚拟内存

该文章是《深入理解计算机系统》中第九章关于 VM 的读书笔记，有大量的原文摘抄，所以本篇文章不在仓库的许可协议之内。如您想了解相关知识请积极购买正版。

虚拟内存提供的三种能力：

- 将主存看成是一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据；
- 为每个进程提供给了一致的地址空间，从而简化内存管理；
- 保护每个进程的地址空间不被其它进程破坏

## 9.1 物理和虚拟寻址

计算机系统的主存被组织成一个由 M 个连续的子节大小的单元组成的数组。每个字节都有一个唯一的物理地址（Physical Address，PA）。

早起直接物理寻址，现代采用虚拟寻址（virtual addressing）。

从 Virtual address，VA 到 Pysical addres，PA 的过程被称为 Address translation。

## 9.2 地址空间

地址空间（Address space）是一个非负整数地址的有序集合。地址空间的大小有表示最大地址所需的位数来描述。32位、64位地址空间。

地址空间的概念很重要，因为他清楚地区分了数据对象（子节）和它们的属性（地址）。主存中的每个子节都有一个选自虚拟地址空间的虚拟地址和一个选自物理地址空间的物理地址。

虚拟地址空间（Virtual address space）。

## 9.3 虚拟内存作为缓存的工具

虚拟内存被组织位一个由存放在次盘上的 N 个连续的字节大小的单元组成的数组。每个字节都有一个唯一的虚拟地址，作为到数组的索引。

虚拟内存被分为虚拟页（Virtual Page， VP），物理内存被分割为物理页（Physical Pages，PP）

任何时刻，虚拟页面的集合都分为三个不相交的子集：

- 为分配的：VM 系统还为分配的页。未分配的块没有任何数据和它们相关联，因此也就不占用任何磁盘空间。
- 缓存的：当前已缓存在物理内存中的已分配页；
- 为缓存的：为缓存在物理内存中的已分配页。

### 9.3.1 DRAM缓存的组织结构

SRAM 缓存表示位于 CPU 和主存之间的 L1，L2，L3高速缓存

DRAM 缓存表示虚拟内存系统的缓存，他在主存中缓存虚拟页。

虚拟页往往很大，通常是4KB～2MB。

DRAM 总是回写，不是直写。

### 9.3.2 页表

页表负责将虚拟页映射到物理页。其实就是一个页表条目（Page Table Entry，PTE）的数组。

![Page table](./images/page_table.png)
