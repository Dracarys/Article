# 【笔记】如何选择锁

介绍锁的文章恐怕多的恐怕牛毛都要望其项背了，但是放眼望去，大多都是简单的罗列一下各个锁，然后在介绍一些用法，无外乎如此。好一点的在对比一下性能。但是如何选择锁，好像介绍的都不够系统。

那么该如何选择锁呢？事实上选择锁的标准就两个点：
- 不能造成死锁
- 性能开销要尽可能的小

### 避免死锁
死锁的四个条件，相信很多人都如数家珍：
1. 条件互斥
2. 占有和等待条件
3. 不可抢占条件
4. 环路等待条件

为了避免死锁，我们通常会用到以下两种技术：
- 层次锁（hierarchical locking）：在多个相关联的锁上规定一个顺序，要求所有的线程都以相同的顺序来加锁；
- 随机锁（stochastic locking）：当某个线程尝试获取一个可能会破坏层次的锁时，可以使用try_lock()来代替lock()操作，尝试获取锁，如果锁已经被持有，它会返回失败，而不是阻塞在这个锁上。

### 递归锁
当一个线程需要获取自己已经拥有的锁时，那么我们就必须使用递归锁，否则将造成死锁。

### 阻塞还是自旋


### 锁对象


### 粒度和持续时间